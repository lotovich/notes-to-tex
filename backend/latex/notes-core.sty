% Minimal core style that wraps your rich tcolorbox environments
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{notes-core}[2025/09/29 Core wrapper style]

% --- encodings ---
\RequirePackage{iftex}
\ifPDFTeX
  \RequirePackage[utf8]{inputenc} % ok для pdflatex
  \RequirePackage[T2A,T1]{fontenc}
  \RequirePackage{tempora} % Times-like family с кириллицей, поддерживает жирный/курсив
\else
  \RequirePackage{fontspec}
  \defaultfontfeatures{Ligatures=TeX}
  \setmainfont{Times New Roman}
  \setsansfont{Arial}
  \setmonofont{Courier New}
\fi
\RequirePackage[english,russian]{babel}

% --- math ---
\RequirePackage{amsmath,amssymb,amsthm,mathtools}
\numberwithin{equation}{section}

% --- graphics & floats ---
\RequirePackage{graphicx}
\graphicspath{{./images/}} % keep your path
\RequirePackage{float}

% --- colors & links ---
\RequirePackage{xcolor}
\definecolor{primaryColor}{HTML}{1F4E79}
\definecolor{secondaryColor}{HTML}{00796B}
\definecolor{accentColor}{HTML}{C2185B}
\definecolor{noteColor}{HTML}{1976D2}
\definecolor{questionColor}{HTML}{5D4037}
\RequirePackage[hidelinks]{hyperref}

% --- cleveref (по желанию, но очень удобно) ---
\RequirePackage[nameinlink,capitalize]{cleveref}

% --- tcolorbox + theorem boxes ---
\RequirePackage[most]{tcolorbox}
\tcbuselibrary{theorems,skins,breakable}

% Общие настройки: белый фон, переносы, жирный заголовок.
% КЛЮЧЕВОЕ: before upper=\ignorespaces — не "съедает" первую букву,
% и не ломает заголовки (в фигурных скобках).
\tcbset{
  mytheobox/.style={
    enhanced, breakable,
    colback=white,
    fonttitle=\bfseries,
    before upper=\ignorespaces
  }
}

% === Definition ===
\newtcbtheorem[auto counter, number within=section]{definitionbox}{Definition}{
  mytheobox,
  colframe=secondaryColor!80!black,
  colbacktitle=secondaryColor, coltitle=white
}{def}

% === Theorem ===
\newtcbtheorem[auto counter, number within=section]{theoremnox}{Theorem}{
  mytheobox,
  colframe=accentColor!80!black,
  colbacktitle=accentColor, coltitle=white
}{thm}

% === Lemma ===
\newtcbtheorem[auto counter, number within=section]{lemmanox}{Lemma}{
  mytheobox,
  colframe=accentColor!80!black,
  colbacktitle=accentColor!80!black, coltitle=white
}{lem}

% === Corollary ===
\newtcbtheorem[auto counter, number within=section]{corollarybox}{Corollary}{
  mytheobox,
  colframe=accentColor!60!black,
  colbacktitle=accentColor!60!black, coltitle=white
}{cor}

% === Example ===
\newtcbtheorem[auto counter, number within=section]{examplebox}{Example}{
  mytheobox,
  colframe=primaryColor!80!black,
  colbacktitle=primaryColor, coltitle=white
}{ex}

% === Note ===
\newtcbtheorem[auto counter, number within=section]{notebox}{Note}{
  mytheobox,
  colframe=noteColor!80!black,
  colbacktitle=noteColor, coltitle=white
}{note}

% === Question ===
\newtcbtheorem[auto counter, number within=section]{questionbox}{Question}{
  mytheobox,
  colframe=questionColor!80!black,
  colbacktitle=questionColor, coltitle=white
}{q}

% --- Proof box ---
\newtcolorbox{proofbox}{
  enhanced, breakable,
  colback=white, boxrule=0.5pt,
  borderline west={2mm}{0pt}{noteColor!70!white},
  sharp corners,
  title={\bfseries Proof},
  before upper=\ignorespaces,
  after={\hfill\ensuremath{\blacksquare}}
}

% === Aliases: короткие имена для тех же боксов ===
\let\definition\definitionbox
\let\enddefinition\enddefinitionbox

\let\theorem\theoremnox
\let\endtheorem\endtheoremnox

\let\lemma\lemmanox
\let\endlemma\endlemmanox

\let\corollary\corollarybox
\let\endcorollary\endcorollarybox

\let\example\examplebox
\let\endexample\endexamplebox

\let\note\notebox
\let\endnote\endnotebox

\let\question\questionbox
\let\endquestion\endquestionbox

% === Thin wrappers for the agent ===
% Агент пишет привычные окружения, а мы заворачиваем в твои боксы.
\RequirePackage{xparse}

\NewDocumentEnvironment{definition}{O{}}
  {\begin{definitionbox}{#1}}
  {\end{definitionbox}}

\NewDocumentEnvironment{theorem}{O{}}
  {\begin{theoremnox}{#1}}
  {\end{theoremnox}}

% theorembox — alias (модель иногда использует это имя)
\NewDocumentEnvironment{theorembox}{O{}}
  {\begin{theoremnox}{#1}}
  {\end{theoremnox}}

\NewDocumentEnvironment{lemma}{O{}}
  {\begin{lemmanox}{#1}}
  {\end{lemmanox}}

\NewDocumentEnvironment{corollary}{O{}}
  {\begin{corollarybox}{#1}}
  {\end{corollarybox}}

\NewDocumentEnvironment{example}{O{}}
  {\begin{examplebox}{#1}}
  {\end{examplebox}}

\NewDocumentEnvironment{noteenv}{O{}}
  {\begin{notebox}{#1}}
  {\end{notebox}}

\NewDocumentEnvironment{question}{O{}}
  {\begin{questionbox}{#1}}
  {\end{questionbox}}

% Привычный proof -> твой красивый бокс
\RenewDocumentEnvironment{proof}{}{\begin{proofbox}}{\end{proofbox}}

% Удобные шорткаты ссылок
\newcommand{\figref}[1]{\cref{#1}}
\newcommand{\eqnref}[1]{\cref{#1}}
\newcommand{\thmref}[1]{\cref{#1}}
\newcommand{\defref}[1]{\cref{#1}}
